---
phase: 07-language-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Models/AppSettings.cs
  - Coxixo/Services/TranscriptionService.cs
  - Coxixo/TrayApplicationContext.cs
  - Coxixo/Forms/SettingsForm.Designer.cs
  - Coxixo/Forms/SettingsForm.cs
autonomous: true
must_haves:
  truths:
    - "User can select transcription language from a dropdown showing Auto-detect, Portuguese, English, Spanish, French, German"
    - "User can choose Auto-detect option and Whisper receives null language parameter"
    - "Selected language persists in settings.json across app restarts"
    - "Whisper API receives correct ISO 639-1 language code (pt, en, es, fr, de) for selected language"
  artifacts:
    - path: "Coxixo/Models/AppSettings.cs"
      provides: "LanguageCode property (string?, default null)"
      contains: "LanguageCode"
    - path: "Coxixo/Services/TranscriptionService.cs"
      provides: "Accepts language parameter, passes to AudioTranscriptionOptions.Language"
      contains: "_languageCode"
    - path: "Coxixo/Forms/SettingsForm.Designer.cs"
      provides: "lblLanguage and cmbLanguage controls"
      contains: "cmbLanguage"
    - path: "Coxixo/Forms/SettingsForm.cs"
      provides: "ComboBox binding, load/save logic with null handling"
      contains: "CmbLanguage_SelectedIndexChanged"
  key_links:
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "Coxixo/Models/AppSettings.cs"
      via: "BtnSave_Click saves LanguageCode from cmbLanguage.SelectedValue"
      pattern: "_settings\\.LanguageCode"
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "Coxixo/Services/TranscriptionService.cs"
      via: "TryInitializeTranscriptionService passes settings.LanguageCode to constructor"
      pattern: "TranscriptionService\\(.*LanguageCode"
    - from: "Coxixo/Services/TranscriptionService.cs"
      to: "AudioTranscriptionOptions"
      via: "Language property set from _languageCode field"
      pattern: "Language\\s*=\\s*_languageCode"
---

<objective>
Add language selection to Coxixo settings, allowing users to choose a transcription language (Portuguese, English, Spanish, French, German) or Auto-detect from a dropdown. The selected language is persisted in settings.json and passed to the Whisper API as an ISO 639-1 code (or null for auto-detect).

Purpose: Fulfills LANG-01 through LANG-04. Users who transcribe in multiple languages can switch without editing config files, and auto-detect provides a zero-config default.
Output: Working language dropdown in settings, language persisted across restarts, Whisper API receives correct language code.
</objective>

<execution_context>
@C:/Users/Myke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Myke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-language-selection/07-RESEARCH.md

@Coxixo/Models/AppSettings.cs
@Coxixo/Services/TranscriptionService.cs
@Coxixo/TrayApplicationContext.cs
@Coxixo/Forms/SettingsForm.cs
@Coxixo/Forms/SettingsForm.Designer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LanguageCode to AppSettings and wire TranscriptionService</name>
  <files>
    Coxixo/Models/AppSettings.cs
    Coxixo/Services/TranscriptionService.cs
    Coxixo/TrayApplicationContext.cs
  </files>
  <action>
    **AppSettings.cs** — Add a nullable string property for the language code:
    ```csharp
    /// <summary>
    /// ISO 639-1 language code for transcription (e.g., "pt", "en", "es").
    /// Null means auto-detect language from audio.
    /// </summary>
    public string? LanguageCode { get; set; } = null;
    ```
    Place it after the StartWithWindows property. Default is null (auto-detect).

    **TranscriptionService.cs** — Accept language as a constructor parameter:
    1. Add a private field: `private readonly string? _languageCode;`
    2. Add `string? languageCode = null` as the 4th constructor parameter (after `deployment`).
    3. Store it: `_languageCode = languageCode;`
    4. In TranscribeAsync, replace the hardcoded `Language = "pt"` with `Language = _languageCode`. When _languageCode is null, the Azure SDK omits the language parameter, triggering Whisper auto-detection.

    **TrayApplicationContext.cs** — Pass language to TranscriptionService in TryInitializeTranscriptionService():
    Change the constructor call from:
    ```csharp
    _transcriptionService = new TranscriptionService(
        _settings.AzureEndpoint,
        apiKey,
        _settings.WhisperDeployment);
    ```
    To:
    ```csharp
    _transcriptionService = new TranscriptionService(
        _settings.AzureEndpoint,
        apiKey,
        _settings.WhisperDeployment,
        _settings.LanguageCode);
    ```
  </action>
  <verify>
    Build succeeds: `dotnet build Coxixo/Coxixo.csproj`
    Confirm no hardcoded "pt" remains in TranscriptionService.cs.
  </verify>
  <done>
    AppSettings has LanguageCode property (string?, default null). TranscriptionService accepts language parameter and passes it to AudioTranscriptionOptions.Language. TrayApplicationContext passes settings.LanguageCode to TranscriptionService constructor. Build compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add language ComboBox to SettingsForm with binding and persistence</name>
  <files>
    Coxixo/Forms/SettingsForm.Designer.cs
    Coxixo/Forms/SettingsForm.cs
  </files>
  <action>
    **SettingsForm.Designer.cs** — Add language controls and adjust layout:

    1. Add field declarations (after the chkStartWithWindows field):
       ```csharp
       // Language
       private Label lblLanguage;
       private ComboBox cmbLanguage;
       ```

    2. In InitializeComponent(), add control creation (after chkStartWithWindows creation):
       ```csharp
       // Language controls
       lblLanguage = new Label();
       cmbLanguage = new ComboBox();
       ```

    3. Add control configuration. Position the language section between the Test Connection button (y=335) and the Start with Windows checkbox. Shift existing controls down to make room:
       - btnTestConnection stays at y=335
       - lblLanguage at y=370, same style as other labels (Segoe UI 8pt Bold), text "TRANSCRIPTION LANGUAGE"
       - cmbLanguage at y=390, Size(280, 25), DropDownStyle = ComboBoxStyle.DropDownList, wire SelectedIndexChanged += CmbLanguage_SelectedIndexChanged
       - chkStartWithWindows moves from y=370 to y=425
       - btnCancel moves from y=400 to y=455
       - btnSave moves from y=400 to y=455
       - ClientSize changes from (304, 440) to (304, 495)

    4. Add controls to form (insert before chkStartWithWindows in Controls.Add sequence):
       ```csharp
       this.Controls.Add(lblLanguage);
       this.Controls.Add(cmbLanguage);
       ```

    **SettingsForm.cs** — Add ComboBox binding, load logic, save logic:

    1. In SetupForm(), after the existing code and before any theme application, populate the ComboBox. CRITICAL: Set DisplayMember and ValueMember BEFORE DataSource to avoid spurious events and ToString() display:
       ```csharp
       var languageOptions = new List<KeyValuePair<string?, string>>
       {
           new(null, "Auto-detect"),
           new("pt", "Portuguese"),
           new("en", "English"),
           new("es", "Spanish"),
           new("fr", "French"),
           new("de", "German")
       };
       cmbLanguage.DisplayMember = "Value";
       cmbLanguage.ValueMember = "Key";
       cmbLanguage.DataSource = languageOptions;
       ```

    2. In ApplyDarkTheme(), add a handler for ComboBox controls (alongside the existing TextBox handler):
       ```csharp
       else if (child is ComboBox cmb)
       {
           cmb.BackColor = DarkTheme.Surface;
           cmb.ForeColor = DarkTheme.Text;
           cmb.FlatStyle = FlatStyle.Flat;
       }
       ```

    3. In LoadSettings(), after the chkStartWithWindows line and before `_isLoading = false`, add null-safe language loading. Do NOT use `cmbLanguage.SelectedValue = null` — it doesn't work in WinForms. Use SelectedIndex = 0 for null (Auto-detect is first item):
       ```csharp
       if (_settings.LanguageCode == null)
           cmbLanguage.SelectedIndex = 0;
       else
           cmbLanguage.SelectedValue = _settings.LanguageCode;
       ```

    4. Add event handler (language saves on Save button click, not immediately — matching the pattern for hotkey/endpoint/deployment):
       ```csharp
       private void CmbLanguage_SelectedIndexChanged(object? sender, EventArgs e)
       {
           if (_isLoading)
               return;
       }
       ```

    5. In BtnSave_Click(), after `_settings.StartWithWindows = chkStartWithWindows.Checked;`, add:
       ```csharp
       _settings.LanguageCode = cmbLanguage.SelectedValue as string;
       ```
       The `as string` cast is null-safe: when Auto-detect is selected, SelectedValue is the null Key from the KeyValuePair, and `null as string` returns null.
  </action>
  <verify>
    Build succeeds: `dotnet build Coxixo/Coxixo.csproj`
    Run the app, open Settings, verify:
    1. Language dropdown appears between Test Connection and Start with Windows
    2. Dropdown shows "Auto-detect" selected by default
    3. All 6 options visible: Auto-detect, Portuguese, English, Spanish, French, German
    4. Selecting a language and clicking Save persists it (check %LOCALAPPDATA%\Coxixo\settings.json for "LanguageCode" field)
    5. Reopening Settings shows the previously saved language selected
    6. Dark theme applied to ComboBox (dark background, white text)
  </verify>
  <done>
    Language ComboBox visible in settings form with 6 options (Auto-detect + 5 languages). Dark theme applied. Selected language persists via Save button. LoadSettings correctly restores selection including null/Auto-detect case. No spurious events during form load.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` — compiles without errors or warnings
2. Run app → open Settings → language dropdown shows "Auto-detect" by default
3. Select "Portuguese" → Save → reopen Settings → "Portuguese" still selected
4. Check settings.json → "LanguageCode": "pt" present
5. Select "Auto-detect" → Save → check settings.json → "LanguageCode": null
6. Record audio with Portuguese selected → Whisper receives language="pt"
7. Record audio with Auto-detect → Whisper receives no language parameter (auto-detects)
8. Form layout: no overlapping controls, proper spacing, all controls visible
</verification>

<success_criteria>
- Language dropdown with 6 options renders correctly in dark-themed settings form
- Auto-detect (null) and explicit language codes persist across app restarts via settings.json
- TranscriptionService passes correct ISO 639-1 code (or null) to Whisper API
- No hardcoded "pt" language in TranscriptionService
- Form layout maintains consistent spacing with no visual regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-language-selection/07-01-SUMMARY.md`
</output>
