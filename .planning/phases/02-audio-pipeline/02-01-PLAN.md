---
phase: 02-audio-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Coxixo.csproj
  - Coxixo/Services/AudioCaptureService.cs
  - Coxixo/TrayApplicationContext.cs
  - Coxixo/Models/AppSettings.cs
autonomous: true

must_haves:
  truths:
    - "Audio is captured from default system microphone when hotkey is held"
    - "Audio is encoded as 16kHz mono WAV suitable for Whisper API"
    - "Short recordings (<0.5s) are discarded silently"
    - "App handles microphone permission denied gracefully with toast notification"
  artifacts:
    - path: "Coxixo/Services/AudioCaptureService.cs"
      provides: "NAudio microphone capture with memory buffer"
      exports: ["AudioCaptureService", "StartCapture", "StopCapture", "GetAudioData"]
    - path: "Coxixo/Models/AppSettings.cs"
      provides: "AudioFeedbackEnabled setting"
      contains: "AudioFeedbackEnabled"
  key_links:
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "AudioCaptureService"
      via: "HotkeyPressed/HotkeyReleased event handlers"
      pattern: "_audioCaptureService\\.(Start|Stop)Capture"
    - from: "Coxixo/Services/AudioCaptureService.cs"
      to: "NAudio.Wave"
      via: "WaveInEvent for microphone capture"
      pattern: "WaveInEvent|WaveFormat"
---

<objective>
Implement NAudio microphone capture that records to memory buffer during push-to-talk hold.

Purpose: Enable audio capture from default Windows microphone, encoding audio in Whisper-compatible format (16kHz mono WAV), with minimum duration threshold to ignore accidental key taps.

Output: AudioCaptureService that integrates with existing KeyboardHookService events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-audio-pipeline/02-CONTEXT.md
@Coxixo/Services/KeyboardHookService.cs
@Coxixo/TrayApplicationContext.cs
@Coxixo/Models/AppSettings.cs
@Coxixo/Coxixo.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NAudio package and create AudioCaptureService</name>
  <files>
    Coxixo/Coxixo.csproj
    Coxixo/Services/AudioCaptureService.cs
    Coxixo/Models/AppSettings.cs
  </files>
  <action>
1. Add NAudio NuGet package to Coxixo.csproj:
   ```xml
   <PackageReference Include="NAudio" Version="2.2.1" />
   ```

2. Add AudioFeedbackEnabled to AppSettings.cs (default true):
   ```csharp
   public bool AudioFeedbackEnabled { get; set; } = true;
   ```

3. Create AudioCaptureService.cs with:
   - Use WaveInEvent (not WaveIn - better for background apps)
   - WaveFormat: 16000 Hz, 16-bit, mono (Whisper optimal)
   - MemoryStream buffer to collect audio data
   - Minimum duration threshold: 0.5 seconds (500ms)
   - Events: RecordingStarted, RecordingStopped, RecordingDiscarded, CaptureError
   - Properties: IsRecording, LastRecordingDuration
   - Methods: StartCapture(), StopCapture() -> returns byte[]? (null if discarded)

   Handle microphone errors:
   - Catch NAudio exceptions on StartCapture
   - Fire CaptureError event with message for toast notification
   - Common errors: device not found, permission denied, device in use

   Implementation pattern:
   ```csharp
   public sealed class AudioCaptureService : IDisposable
   {
       private const int SampleRate = 16000;
       private const int BitsPerSample = 16;
       private const int Channels = 1;
       private const int MinDurationMs = 500;

       private WaveInEvent? _waveIn;
       private MemoryStream? _buffer;
       private WaveFileWriter? _writer;
       private DateTime _recordingStart;
       private bool _isRecording;

       public event EventHandler? RecordingStarted;
       public event EventHandler? RecordingStopped;
       public event EventHandler? RecordingDiscarded;
       public event EventHandler<string>? CaptureError;

       public bool IsRecording => _isRecording;
       public TimeSpan LastRecordingDuration { get; private set; }

       public void StartCapture() { ... }
       public byte[]? StopCapture() { ... }  // Returns WAV bytes or null if too short
       public void Dispose() { ... }
   }
   ```

4. WAV encoding: Use WaveFileWriter to write directly to MemoryStream in proper WAV format with headers. The StopCapture method returns the complete WAV byte array ready for Whisper API.
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` - should compile with no errors
  </verify>
  <done>
    AudioCaptureService exists with NAudio WaveInEvent capturing 16kHz mono audio to memory buffer. Minimum duration check implemented. CaptureError event for microphone problems.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AudioCaptureService to keyboard events and add toast notifications</name>
  <files>
    Coxixo/TrayApplicationContext.cs
  </files>
  <action>
1. Add AudioCaptureService field to TrayApplicationContext:
   ```csharp
   private readonly AudioCaptureService _audioCaptureService;
   ```

2. Initialize in constructor after settings load:
   ```csharp
   _audioCaptureService = new AudioCaptureService();
   _audioCaptureService.RecordingStarted += OnRecordingStarted;
   _audioCaptureService.RecordingStopped += OnRecordingStopped;
   _audioCaptureService.RecordingDiscarded += OnRecordingDiscarded;
   _audioCaptureService.CaptureError += OnCaptureError;
   ```

3. Wire hotkey events to audio capture:
   ```csharp
   private void OnHotkeyPressed(object? sender, EventArgs e)
   {
       _trayIcon.Icon = _recordingIcon;
       _trayIcon.Text = "Coxixo - Recording...";
       _audioCaptureService.StartCapture();
   }

   private void OnHotkeyReleased(object? sender, EventArgs e)
   {
       var audioData = _audioCaptureService.StopCapture();
       _trayIcon.Icon = _idleIcon;
       _trayIcon.Text = $"Coxixo - Press {_settings.HotkeyKey} to talk";

       if (audioData != null)
       {
           // Phase 3 will send this to Whisper API
           // For now, just log the size
           Debug.WriteLine($"Captured {audioData.Length} bytes of audio");
       }
   }
   ```

4. Handle capture errors with Windows toast notification:
   ```csharp
   private void OnCaptureError(object? sender, string message)
   {
       // Use NotifyIcon balloon for toast-like notification
       _trayIcon.BalloonTipTitle = "Coxixo - Microphone Error";
       _trayIcon.BalloonTipText = message;
       _trayIcon.BalloonTipIcon = ToolTipIcon.Warning;
       _trayIcon.ShowBalloonTip(5000);
   }
   ```

   Note: For true Windows toast notifications with action buttons (open mic settings), that requires Microsoft.Toolkit.Uwp.Notifications package. For Phase 2, use NotifyIcon.BalloonTip which works without extra dependencies. Phase 4 can upgrade to full toast notifications if needed.

5. Dispose AudioCaptureService in Dispose method:
   ```csharp
   _audioCaptureService?.Dispose();
   ```

6. Handle recording discarded (optional debug logging):
   ```csharp
   private void OnRecordingDiscarded(object? sender, EventArgs e)
   {
       Debug.WriteLine("Recording too short, discarded");
   }
   ```
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` - should compile with no errors.
    Run the app, hold hotkey for 1+ second, release - Debug output shows captured bytes.
    Quick tap (<0.5s) - no bytes captured (discarded).
  </verify>
  <done>
    AudioCaptureService wired to keyboard events. Recording starts on hotkey press, stops on release. Short recordings discarded. Microphone errors shown as balloon notifications.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` compiles without errors
2. Run app, hold F8 for 2 seconds while speaking, release
3. Check debug output shows captured audio bytes (should be ~64KB for 2s at 16kHz/16-bit/mono)
4. Quick tap F8 (<0.5s) should result in no capture (discarded silently)
5. With no microphone connected, holding F8 should show balloon notification about mic error
</verification>

<success_criteria>
- NAudio 2.2.1 package installed
- AudioCaptureService captures 16kHz mono WAV to memory
- Minimum duration threshold (0.5s) prevents accidental captures
- Microphone errors surface as balloon notifications
- Integration with KeyboardHookService events works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio-pipeline/02-01-SUMMARY.md`
</output>
