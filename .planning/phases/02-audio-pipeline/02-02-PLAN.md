---
phase: 02-audio-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Coxixo/Services/AudioFeedbackService.cs
  - Coxixo/TrayApplicationContext.cs
  - Coxixo/Resources/beep-start.wav
  - Coxixo/Resources/beep-stop.wav
  - Coxixo/Coxixo.csproj
autonomous: true

must_haves:
  truths:
    - "User hears ascending chirp when recording starts"
    - "User hears descending chirp when recording stops (if not discarded)"
    - "No stop beep plays for short recordings (<0.5s)"
    - "Audio feedback volume follows Windows system sounds slider"
    - "Audio feedback can be disabled via settings"
  artifacts:
    - path: "Coxixo/Services/AudioFeedbackService.cs"
      provides: "Beep playback using NAudio"
      exports: ["AudioFeedbackService", "PlayStartBeep", "PlayStopBeep"]
    - path: "Coxixo/Resources/beep-start.wav"
      provides: "Ascending chirp sound effect"
    - path: "Coxixo/Resources/beep-stop.wav"
      provides: "Descending chirp sound effect"
  key_links:
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "AudioFeedbackService"
      via: "Recording events trigger beep playback"
      pattern: "_audioFeedbackService\\.Play(Start|Stop)Beep"
    - from: "Coxixo/Services/AudioFeedbackService.cs"
      to: "NAudio.Wave"
      via: "WaveOutEvent for sound playback"
      pattern: "WaveOutEvent|AudioFileReader"
---

<objective>
Add audio feedback beeps (walkie-talkie style chirps) for recording start/stop.

Purpose: Provide auditory confirmation that push-to-talk activated and deactivated, matching user expectation of "walkie-talkie chirps" from CONTEXT.md.

Output: AudioFeedbackService with embedded beep sounds that play on recording events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-audio-pipeline/02-CONTEXT.md
@.planning/phases/02-audio-pipeline/02-01-SUMMARY.md
@Coxixo/TrayApplicationContext.cs
@Coxixo/Models/AppSettings.cs
@Coxixo/Coxixo.csproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate beep WAV files and create AudioFeedbackService</name>
  <files>
    Coxixo/Resources/beep-start.wav
    Coxixo/Resources/beep-stop.wav
    Coxixo/Services/AudioFeedbackService.cs
    Coxixo/Coxixo.csproj
  </files>
  <action>
1. Generate beep sound files programmatically using NAudio or C# code:

   Create a helper to generate the WAV files once during development, then embed them.

   **beep-start.wav** (ascending chirp, ~150ms):
   - Start frequency: 800 Hz
   - End frequency: 1200 Hz
   - Duration: 150ms
   - Fade in/out to avoid clicks
   - Format: 16kHz, 16-bit, mono (matches capture format)

   **beep-stop.wav** (descending chirp, ~150ms):
   - Start frequency: 1200 Hz
   - End frequency: 800 Hz
   - Duration: 150ms
   - Fade in/out to avoid clicks
   - Format: 16kHz, 16-bit, mono

   Implementation approach - create a simple console app or use a script:
   ```csharp
   static void GenerateChirp(string filename, int startFreq, int endFreq, int durationMs)
   {
       int sampleRate = 16000;
       int samples = sampleRate * durationMs / 1000;
       using var writer = new WaveFileWriter(filename, new WaveFormat(sampleRate, 16, 1));

       for (int i = 0; i < samples; i++)
       {
           double t = (double)i / samples;
           double freq = startFreq + (endFreq - startFreq) * t;
           double sample = Math.Sin(2 * Math.PI * freq * i / sampleRate);

           // Fade envelope (first/last 20% of duration)
           double envelope = 1.0;
           if (t < 0.2) envelope = t / 0.2;
           else if (t > 0.8) envelope = (1.0 - t) / 0.2;

           sample *= envelope * 0.7;  // 70% volume
           writer.WriteSample((float)sample);
       }
   }
   ```

   OR use pre-made short beep WAVs. The key is:
   - Short duration (100-200ms)
   - Ascending for start, descending for stop
   - Pleasant tech sound (not harsh)

2. Add WAV files as embedded resources in Coxixo.csproj:
   ```xml
   <EmbeddedResource Include="Resources\beep-start.wav" />
   <EmbeddedResource Include="Resources\beep-stop.wav" />
   ```

3. Create AudioFeedbackService.cs:
   ```csharp
   public sealed class AudioFeedbackService : IDisposable
   {
       private readonly WaveOutEvent _waveOut;
       private readonly byte[] _startBeepData;
       private readonly byte[] _stopBeepData;
       private bool _enabled = true;

       public bool Enabled
       {
           get => _enabled;
           set => _enabled = value;
       }

       public AudioFeedbackService()
       {
           _waveOut = new WaveOutEvent();
           _startBeepData = LoadEmbeddedResource("Coxixo.Resources.beep-start.wav");
           _stopBeepData = LoadEmbeddedResource("Coxixo.Resources.beep-stop.wav");
       }

       public void PlayStartBeep()
       {
           if (!_enabled) return;
           PlaySound(_startBeepData);
       }

       public void PlayStopBeep()
       {
           if (!_enabled) return;
           PlaySound(_stopBeepData);
       }

       private void PlaySound(byte[] wavData)
       {
           try
           {
               // Stop any currently playing sound
               _waveOut.Stop();

               // Play from memory stream
               var ms = new MemoryStream(wavData);
               var reader = new WaveFileReader(ms);
               _waveOut.Init(reader);
               _waveOut.Play();
               // Note: WaveOutEvent plays asynchronously, sound will complete naturally
           }
           catch (Exception ex)
           {
               Debug.WriteLine($"Audio feedback error: {ex.Message}");
               // Silently fail - audio feedback is nice-to-have
           }
       }

       private byte[] LoadEmbeddedResource(string resourceName)
       {
           var assembly = Assembly.GetExecutingAssembly();
           using var stream = assembly.GetManifestResourceStream(resourceName);
           if (stream == null)
               return Array.Empty<byte>();

           using var ms = new MemoryStream();
           stream.CopyTo(ms);
           return ms.ToArray();
       }

       public void Dispose()
       {
           _waveOut?.Dispose();
       }
   }
   ```

   Note: WaveOutEvent uses the default audio output device and respects Windows volume settings. The "system sounds" volume slider in Windows affects default playback device volume.
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` - should compile with no errors.
    Verify Resources/beep-start.wav and Resources/beep-stop.wav exist.
  </verify>
  <done>
    AudioFeedbackService created with embedded WAV beeps. Start beep is ascending chirp, stop beep is descending chirp. Both ~150ms duration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AudioFeedbackService to recording events</name>
  <files>
    Coxixo/TrayApplicationContext.cs
  </files>
  <action>
1. Add AudioFeedbackService field:
   ```csharp
   private readonly AudioFeedbackService _audioFeedbackService;
   ```

2. Initialize in constructor (after settings load):
   ```csharp
   _audioFeedbackService = new AudioFeedbackService();
   _audioFeedbackService.Enabled = _settings.AudioFeedbackEnabled;
   ```

3. Update AudioCaptureService event handlers to play beeps:
   ```csharp
   private void OnRecordingStarted(object? sender, EventArgs e)
   {
       _audioFeedbackService.PlayStartBeep();
   }

   private void OnRecordingStopped(object? sender, EventArgs e)
   {
       _audioFeedbackService.PlayStopBeep();
   }

   // No beep on RecordingDiscarded - this is intentional per CONTEXT.md
   private void OnRecordingDiscarded(object? sender, EventArgs e)
   {
       Debug.WriteLine("Recording too short, discarded (no beep)");
   }
   ```

4. Wire events in constructor (before StartCapture can be called):
   ```csharp
   _audioCaptureService.RecordingStarted += OnRecordingStarted;
   _audioCaptureService.RecordingStopped += OnRecordingStopped;
   _audioCaptureService.RecordingDiscarded += OnRecordingDiscarded;
   ```

5. Dispose AudioFeedbackService:
   ```csharp
   _audioFeedbackService?.Dispose();
   ```

Important: The RecordingStarted event from AudioCaptureService should fire AFTER capture starts successfully, so the start beep only plays if microphone access works. The RecordingStopped event should fire only for recordings that meet the minimum duration threshold (not for discarded recordings).
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` - should compile with no errors.
    Run the app:
    - Hold F8 for 1+ second, release: hear ascending chirp on press, descending chirp on release
    - Quick tap F8 (<0.5s): hear ascending chirp on press, NO beep on release (discarded)
    - Test volume follows Windows audio slider
  </verify>
  <done>
    Audio feedback plays on recording start (ascending) and stop (descending). No stop beep for discarded recordings. Volume follows Windows system settings. Can be disabled via AudioFeedbackEnabled setting.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` compiles without errors
2. Run app, hold F8 for 2 seconds:
   - Ascending chirp plays immediately on press
   - Descending chirp plays on release
3. Quick tap F8 (<0.5s):
   - Ascending chirp plays on press
   - NO descending chirp on release (recording discarded)
4. Adjust Windows audio volume slider - beep volume should change
5. Set AudioFeedbackEnabled=false in settings.json, restart - no beeps
</verification>

<success_criteria>
- beep-start.wav and beep-stop.wav embedded as resources
- AudioFeedbackService plays sounds using NAudio WaveOutEvent
- Start beep: ascending chirp (~150ms, 800->1200 Hz)
- Stop beep: descending chirp (~150ms, 1200->800 Hz)
- No stop beep for discarded recordings (per CONTEXT.md)
- Volume respects Windows audio settings
- AudioFeedbackEnabled setting works
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio-pipeline/02-02-SUMMARY.md`
</output>
