---
phase: 06-windows-startup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Services/StartupService.cs
  - Coxixo/Models/AppSettings.cs
  - Coxixo/Forms/SettingsForm.cs
  - Coxixo/Forms/SettingsForm.Designer.cs
autonomous: true

must_haves:
  truths:
    - "User can toggle 'Start with Windows' checkbox in settings"
    - "Checking the box immediately writes Coxixo to HKCU Run registry key"
    - "Unchecking the box immediately removes Coxixo from HKCU Run registry key"
    - "Checkbox reflects actual registry state when settings window opens"
    - "Registry write failure shows error message and reverts checkbox"
  artifacts:
    - path: "Coxixo/Services/StartupService.cs"
      provides: "Registry operations for Windows startup"
      contains: "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
      exports: ["IsEnabled", "Enable", "Disable"]
    - path: "Coxixo/Models/AppSettings.cs"
      provides: "StartWithWindows preference property"
      contains: "StartWithWindows"
    - path: "Coxixo/Forms/SettingsForm.Designer.cs"
      provides: "CheckBox control declaration and layout"
      contains: "chkStartWithWindows"
    - path: "Coxixo/Forms/SettingsForm.cs"
      provides: "CheckedChanged handler with immediate registry toggle"
      contains: "ChkStartWithWindows_CheckedChanged"
  key_links:
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "Coxixo/Services/StartupService.cs"
      via: "CheckedChanged calls Enable/Disable"
      pattern: "StartupService\\.(Enable|Disable)\\(\\)"
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "Coxixo/Services/StartupService.cs"
      via: "LoadSettings reads IsEnabled for checkbox state"
      pattern: "StartupService\\.IsEnabled\\(\\)"
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "Coxixo/Models/AppSettings.cs"
      via: "BtnSave persists StartWithWindows to settings JSON"
      pattern: "_settings\\.StartWithWindows"
---

<objective>
Add "Start with Windows" checkbox to SettingsForm that toggles Windows startup registration via HKCU Run registry key, with immediate registry write on toggle and accurate state reflection on form open.

Purpose: Enables users to configure Coxixo to launch automatically at Windows login (START-01, START-02, START-03).
Output: StartupService.cs, updated AppSettings.cs, updated SettingsForm with checkbox.
</objective>

<execution_context>
@C:/Users/Myke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Myke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-windows-startup/06-RESEARCH.md

@Coxixo/Models/AppSettings.cs
@Coxixo/Services/ConfigurationService.cs
@Coxixo/Forms/SettingsForm.cs
@Coxixo/Forms/SettingsForm.Designer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StartupService and extend AppSettings</name>
  <files>
    Coxixo/Services/StartupService.cs
    Coxixo/Models/AppSettings.cs
  </files>
  <action>
    Create `Coxixo/Services/StartupService.cs` as a static class following the existing ConfigurationService/CredentialService pattern:

    **StartupService.cs:**
    - Namespace: `Coxixo.Services`
    - Static class with three methods: `IsEnabled()`, `Enable()`, `Disable()`
    - Constants: `RunKeyPath = @"Software\Microsoft\Windows\CurrentVersion\Run"`, `AppName = "Coxixo"`
    - `IsEnabled()`:
      - Opens `Registry.CurrentUser.OpenSubKey(RunKeyPath, writable: false)`
      - Returns `false` if key is null or value is null
      - Compares registry value (case-insensitive) against `$"\"{Application.ExecutablePath}\""`
      - Wraps in try-catch, returns `false` on any exception (safe default)
    - `Enable()`:
      - Opens `Registry.CurrentUser.OpenSubKey(RunKeyPath, writable: true)`
      - Throws `InvalidOperationException` if key is null (Run key missing = system corruption)
      - Writes quoted executable path: `$"\"{Application.ExecutablePath}\""` as `RegistryValueKind.String`
      - Lets `UnauthorizedAccessException` propagate (caller handles)
    - `Disable()`:
      - Opens `Registry.CurrentUser.OpenSubKey(RunKeyPath, writable: true)`
      - Returns silently if key is null (nothing to do)
      - Calls `key.DeleteValue(AppName, throwOnMissingValue: false)`
      - Catches `UnauthorizedAccessException` silently (user intent is "not started", permission failure achieves same outcome)
    - All RegistryKey usage with `using` statements for proper disposal
    - Uses `Microsoft.Win32` and `System.Windows.Forms` (both built-in, no new packages)

    **AppSettings.cs:**
    - Add property: `public bool StartWithWindows { get; set; } = false;`
    - XML doc: "Whether the user enabled 'Start with Windows' in settings. Note: Actual startup state is in registry - this stores user's last choice."
    - Place after `AudioFeedbackEnabled` property
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` — must succeed with zero errors.
    Verify `StartupService.cs` exists in `Coxixo/Services/`.
    Verify `AppSettings.cs` contains `StartWithWindows` property.
  </verify>
  <done>
    StartupService has IsEnabled/Enable/Disable methods accessing HKCU Run key with proper null checks, quoted paths, exception handling, and using statements. AppSettings has StartWithWindows bool property defaulting to false.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add startup checkbox to SettingsForm with immediate registry toggle</name>
  <files>
    Coxixo/Forms/SettingsForm.Designer.cs
    Coxixo/Forms/SettingsForm.cs
  </files>
  <action>
    **SettingsForm.Designer.cs — Add checkbox control:**
    - Declare field: `private CheckBox chkStartWithWindows;` alongside other control declarations
    - In `InitializeComponent()`:
      - Create: `chkStartWithWindows = new CheckBox();`
      - Position below the deployment textbox and Test Connection button area. Current layout ends with:
        - `txtDeployment` at Y=300 (height 25, so bottom at ~325)
        - `btnTestConnection` at Y=335 (height 25, so bottom at ~360)
        - `btnCancel`/`btnSave` at Y=365 (height 30, so bottom at ~395)
      - Place checkbox at `new Point(12, 370)` with `new Size(280, 20)` — between Test Connection and Cancel/Save buttons
      - Set `Name = "chkStartWithWindows"`, `Text = "Start with Windows"`
      - Wire event: `chkStartWithWindows.CheckedChanged += ChkStartWithWindows_CheckedChanged;`
      - Add to form: `this.Controls.Add(chkStartWithWindows);`
      - Move buttons down to accommodate checkbox:
        - `btnCancel.Location = new Point(127, 400);` (was 365)
        - `btnSave.Location = new Point(212, 400);` (was 365)
      - Update form size: `this.ClientSize = new Size(304, 440);` (was 405, add 35px for checkbox + spacing)

    **SettingsForm.cs — Add checkbox logic:**
    - Add `using Coxixo.Services;` if not already present (it likely already is for ConfigurationService reference, but StartupService is in same namespace)
    - In `LoadSettings()`, after existing settings loading, add:
      ```
      chkStartWithWindows.Checked = StartupService.IsEnabled();
      ```
      Read from registry (source of truth), NOT from `_settings.StartWithWindows`.

    - Add `ChkStartWithWindows_CheckedChanged` handler:
      ```
      private void ChkStartWithWindows_CheckedChanged(object? sender, EventArgs e)
      {
          try
          {
              if (chkStartWithWindows.Checked)
                  StartupService.Enable();
              else
                  StartupService.Disable();
          }
          catch (UnauthorizedAccessException)
          {
              MessageBox.Show(
                  "Cannot modify startup settings. Your system administrator may have restricted this feature.",
                  "Permission Denied",
                  MessageBoxButtons.OK,
                  MessageBoxIcon.Warning);
              chkStartWithWindows.Checked = StartupService.IsEnabled();
          }
          catch (Exception ex)
          {
              MessageBox.Show(
                  $"Failed to update startup settings: {ex.Message}",
                  "Error",
                  MessageBoxButtons.OK,
                  MessageBoxIcon.Error);
              chkStartWithWindows.Checked = StartupService.IsEnabled();
          }
      }
      ```
      Registry changes apply immediately on toggle (not deferred to Save).
      On exception, revert checkbox to actual registry state.

    - In `BtnSave_Click`, before `ConfigurationService.Save(_settings)`, add:
      ```
      _settings.StartWithWindows = chkStartWithWindows.Checked;
      ```
      Saves user's last successful preference to JSON for audit trail.

    - In `ApplyDarkTheme`, add CheckBox handling in the control type chain (before the recursive `ApplyDarkTheme(child)` call):
      ```
      else if (child is CheckBox cb)
      {
          cb.ForeColor = DarkTheme.Text;
      }
      ```
      CheckBox inherits parent background via transparency. Only ForeColor needs explicit setting for text visibility.

    **Important: Prevent re-entrant CheckedChanged during LoadSettings.**
    The `LoadSettings()` method sets `chkStartWithWindows.Checked = StartupService.IsEnabled()`, which fires `CheckedChanged`, which tries to call `Enable()`/`Disable()` — creating a redundant registry write on form open. To prevent this, use a `_isLoading` guard:
    - Add field: `private bool _isLoading;`
    - In `LoadSettings()`: set `_isLoading = true;` before loading, `_isLoading = false;` after
    - In `ChkStartWithWindows_CheckedChanged`: early return if `_isLoading` is true
  </action>
  <verify>
    Run `dotnet build Coxixo/Coxixo.csproj` — must succeed with zero errors.
    Verify `SettingsForm.Designer.cs` contains `chkStartWithWindows` declaration and initialization.
    Verify `SettingsForm.cs` contains `ChkStartWithWindows_CheckedChanged` method.
    Verify `SettingsForm.cs` `LoadSettings` reads from `StartupService.IsEnabled()`.
    Verify `SettingsForm.cs` `BtnSave_Click` persists `_settings.StartWithWindows`.
    Verify `ApplyDarkTheme` has CheckBox branch.
    Verify `_isLoading` guard prevents redundant registry writes on form open.
    Verify `SettingsForm.cs` `SetupForm` sets form Size to accommodate new checkbox (height increased).
  </verify>
  <done>
    SettingsForm shows "Start with Windows" checkbox. Checkbox reads from registry on form open (source of truth). Toggle immediately writes/removes HKCU Run key entry. Registry write failures show user-friendly error and revert checkbox. Save button persists preference to AppSettings JSON. Dark theme applied to checkbox. No redundant registry writes on form load.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` succeeds with zero errors
2. `Coxixo/Services/StartupService.cs` exists with IsEnabled, Enable, Disable methods
3. `Coxixo/Models/AppSettings.cs` contains `StartWithWindows` property
4. `SettingsForm.Designer.cs` declares and initializes `chkStartWithWindows`
5. `SettingsForm.cs` reads registry state on load, applies on toggle, saves on Save
6. Form height increased to accommodate checkbox between Test Connection and Cancel/Save buttons
7. Dark theme applied to checkbox via ApplyDarkTheme
8. Re-entrant guard prevents unnecessary registry write during form load
</verification>

<success_criteria>
- START-01: User can toggle "Start with Windows" checkbox in settings
- START-02: Toggle immediately updates Windows startup registry (HKCU Run key with quoted path)
- START-03: Checkbox reflects current startup registration when settings window opens (reads from registry, not settings file)
- Registry write failure handled gracefully with error dialog and checkbox revert
- Build succeeds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-windows-startup/06-01-SUMMARY.md`
</output>
