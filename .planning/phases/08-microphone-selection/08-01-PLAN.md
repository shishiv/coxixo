---
phase: 08-microphone-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Models/AppSettings.cs
  - Coxixo/Services/AudioCaptureService.cs
  - Coxixo/Forms/SettingsForm.Designer.cs
  - Coxixo/Forms/SettingsForm.cs
  - Coxixo/TrayApplicationContext.cs
autonomous: true
must_haves:
  truths:
    - "User can see all active audio capture devices listed in a dropdown with friendly (non-truncated) names"
    - "User can select which microphone to use for recording"
    - "System default microphone is clearly indicated with '(System Default)' suffix in the device list"
    - "Selected microphone persists across app restarts and is used on next recording"
    - "App gracefully falls back to default device if selected microphone becomes unavailable"
  artifacts:
    - path: "Coxixo/Models/AppSettings.cs"
      provides: "MicrophoneDeviceNumber property"
      contains: "MicrophoneDeviceNumber"
    - path: "Coxixo/Services/AudioCaptureService.cs"
      provides: "Device-aware StartCapture with fallback"
      contains: "deviceNumber"
    - path: "Coxixo/Forms/SettingsForm.Designer.cs"
      provides: "Microphone label and ComboBox controls"
      contains: "cmbMicrophone"
    - path: "Coxixo/Forms/SettingsForm.cs"
      provides: "Device enumeration, validation, binding, and save logic"
      contains: "EnumerateAudioDevices"
    - path: "Coxixo/TrayApplicationContext.cs"
      provides: "Passes MicrophoneDeviceNumber to StartCapture"
      contains: "MicrophoneDeviceNumber"
  key_links:
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "Coxixo/Services/AudioCaptureService.cs"
      via: "StartCapture(settings.MicrophoneDeviceNumber)"
      pattern: "StartCapture.*MicrophoneDeviceNumber"
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "Coxixo/Models/AppSettings.cs"
      via: "Save button writes MicrophoneDeviceNumber"
      pattern: "MicrophoneDeviceNumber.*=.*cmbMicrophone"
    - from: "Coxixo/Forms/SettingsForm.cs"
      to: "NAudio.CoreAudioApi.MMDeviceEnumerator"
      via: "EnumerateAudioDevices uses hybrid CoreAudio + WaveInEvent matching"
      pattern: "MMDeviceEnumerator"
---

<objective>
Add microphone selection to Coxixo settings, allowing users to choose which audio input device to use for recording.

Purpose: Users with multiple microphones (USB headset, built-in mic, Bluetooth) need to select which device captures their voice, rather than always using the system default.

Output: MicrophoneDeviceNumber in AppSettings, device-aware AudioCaptureService.StartCapture, microphone ComboBox in SettingsForm with hybrid MMDeviceEnumerator/WaveInEvent enumeration, and TrayApplicationContext wiring.
</objective>

<execution_context>
@C:/Users/Myke/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Myke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-microphone-selection/08-RESEARCH.md
@.planning/phases/07-language-selection/07-01-SUMMARY.md
@Coxixo/Models/AppSettings.cs
@Coxixo/Services/AudioCaptureService.cs
@Coxixo/Forms/SettingsForm.cs
@Coxixo/Forms/SettingsForm.Designer.cs
@Coxixo/TrayApplicationContext.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MicrophoneDeviceNumber to AppSettings and device-aware StartCapture to AudioCaptureService</name>
  <files>
    Coxixo/Models/AppSettings.cs
    Coxixo/Services/AudioCaptureService.cs
  </files>
  <action>
**AppSettings.cs** — Add property after LanguageCode:

```csharp
/// <summary>
/// Selected microphone device number (0-based index from WaveInEvent.DeviceCount).
/// Null means use system default device (DeviceNumber = 0).
/// </summary>
public int? MicrophoneDeviceNumber { get; set; } = null;
```

**AudioCaptureService.cs** — Modify `StartCapture()` to accept an optional device number parameter:

1. Change signature from `public void StartCapture()` to `public void StartCapture(int? deviceNumber = null)`
2. Update the XML doc comment to reflect the new parameter: "Starts capturing audio from the specified microphone" with param doc "Device number (0-based index), or null for system default."
3. In the WaveInEvent constructor, add `DeviceNumber = deviceNumber ?? 0` (before the existing WaveFormat and BufferMilliseconds lines)
4. Update the BadDeviceId error message from "No microphone found. Check your audio devices." to "Selected microphone not found. Falling back to default device."
5. After the `CaptureError?.Invoke` call in the BadDeviceId case, add a fallback retry: if `deviceNumber != null`, recursively call `StartCapture(null)` to retry with default device

The fallback retry ensures that if the saved device was unplugged, recording still works seamlessly with the default device rather than silently failing.

Do NOT change StopCapture, CleanupRecording, or any other methods.
  </action>
  <verify>
Run `dotnet build Coxixo/Coxixo.csproj` — must succeed with 0 errors. Grep for `MicrophoneDeviceNumber` in AppSettings.cs. Grep for `deviceNumber` parameter in AudioCaptureService.cs StartCapture method.
  </verify>
  <done>
AppSettings has nullable int MicrophoneDeviceNumber defaulting to null. AudioCaptureService.StartCapture accepts optional device number, sets WaveInEvent.DeviceNumber, and falls back to default device on BadDeviceId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add microphone ComboBox to SettingsForm with hybrid device enumeration, wire TrayApplicationContext</name>
  <files>
    Coxixo/Forms/SettingsForm.Designer.cs
    Coxixo/Forms/SettingsForm.cs
    Coxixo/TrayApplicationContext.cs
  </files>
  <action>
**SettingsForm.Designer.cs** — Add microphone controls following language dropdown pattern:

1. Add field declarations (after the Language section comment):
   ```csharp
   // Microphone
   private Label lblMicrophone;
   private ComboBox cmbMicrophone;
   ```

2. In `InitializeComponent()`, add construction (after language controls construction):
   ```csharp
   // Microphone controls
   lblMicrophone = new Label();
   cmbMicrophone = new ComboBox();
   ```

3. Add positioning — place microphone section between language dropdown and startup checkbox:
   - `lblMicrophone`: Location = (12, 425), AutoSize = true, Font = new Font("Segoe UI", 8F, FontStyle.Bold), Text = "MICROPHONE"
   - `cmbMicrophone`: Location = (12, 445), Size = (280, 25), DropDownStyle = DropDownList, SelectedIndexChanged += CmbMicrophone_SelectedIndexChanged

4. Shift existing controls down by 55px:
   - `chkStartWithWindows`: Location from (12, 425) to (12, 480)
   - `btnCancel`: Location from (127, 455) to (127, 510)
   - `btnSave`: Location from (212, 455) to (212, 510)
   - `ClientSize`: from (304, 495) to (304, 550)

5. Add controls to form (insert after cmbLanguage, before chkStartWithWindows):
   ```csharp
   this.Controls.Add(lblMicrophone);
   this.Controls.Add(cmbMicrophone);
   ```

**SettingsForm.cs** — Add device enumeration, loading, event handler, and save logic:

1. Add using directives at top of file:
   ```csharp
   using NAudio.Wave;
   using NAudio.CoreAudioApi;
   ```

2. Add `EnumerateAudioDevices()` private method that returns `List<KeyValuePair<int?, string>>`:
   - Start with `new(null, "System Default")` as first item
   - Use `try/catch` wrapping the CoreAudio enumeration (fallback to basic WaveInEvent enumeration on failure)
   - Inside try: create `MMDeviceEnumerator`, get default capture endpoint via `GetDefaultAudioEndpoint(DataFlow.Capture, Role.Console)`, enumerate active capture endpoints
   - Loop `WaveInEvent.DeviceCount` times: for each device number, get `WaveInEvent.GetCapabilities(i)`, find matching MMDevice by `FriendlyName.StartsWith(caps.ProductName, StringComparison.OrdinalIgnoreCase)`, use MMDevice.FriendlyName if found, else caps.ProductName
   - If matched MMDevice.ID equals defaultDevice.ID, append " (System Default)" to display name
   - In catch block: fall back to simple loop using `WaveInEvent.GetCapabilities(i).ProductName`
   - Return the list

3. Add `ValidateDeviceNumber(int? deviceNumber)` private method returning `int?`:
   - If null, return null (system default always valid)
   - If `deviceNumber.Value >= 0 && deviceNumber.Value < WaveInEvent.DeviceCount`, try `WaveInEvent.GetCapabilities(deviceNumber.Value)` — if succeeds return deviceNumber, if exception return null
   - Otherwise return null (device index out of range)

4. Update `LoadSettings()` — add after the language selection block (before `_isLoading = false`):
   ```csharp
   // Microphone selection — enumerate fresh on each settings open
   var devices = EnumerateAudioDevices();
   cmbMicrophone.DisplayMember = "Value";
   cmbMicrophone.ValueMember = "Key";
   cmbMicrophone.DataSource = devices;

   int? validatedDevice = ValidateDeviceNumber(_settings.MicrophoneDeviceNumber);
   if (validatedDevice == null)
       cmbMicrophone.SelectedIndex = 0;
   else
       cmbMicrophone.SelectedValue = validatedDevice;
   ```

   CRITICAL: Set DisplayMember/ValueMember BEFORE DataSource (Phase 7 pattern). Enumerate in LoadSettings (not SetupForm) so device list refreshes each time settings window opens.

5. Add `CmbMicrophone_SelectedIndexChanged` event handler (same pattern as CmbLanguage):
   ```csharp
   private void CmbMicrophone_SelectedIndexChanged(object? sender, EventArgs e)
   {
       if (_isLoading)
           return;
   }
   ```

6. Update `BtnSave_Click` — add line after `_settings.LanguageCode = cmbLanguage.SelectedValue as string;`:
   ```csharp
   _settings.MicrophoneDeviceNumber = cmbMicrophone.SelectedValue as int?;
   ```

**TrayApplicationContext.cs** — Wire device number to StartCapture:

1. In `OnHotkeyPressed`, change `_audioCaptureService.StartCapture()` to `_audioCaptureService.StartCapture(_settings.MicrophoneDeviceNumber)`

This ensures the saved microphone device is passed to every recording. The fallback in AudioCaptureService handles invalid device numbers.
  </action>
  <verify>
Run `dotnet build Coxixo/Coxixo.csproj` — must succeed with 0 errors. Verify:
- Grep `cmbMicrophone` in SettingsForm.Designer.cs (control exists)
- Grep `EnumerateAudioDevices` in SettingsForm.cs (enumeration method exists)
- Grep `MMDeviceEnumerator` in SettingsForm.cs (hybrid enumeration used)
- Grep `MicrophoneDeviceNumber` in TrayApplicationContext.cs (wiring exists)
- Grep `System Default` in SettingsForm.cs (default option present)
- Confirm ClientSize is (304, 550) in Designer.cs
- Confirm chkStartWithWindows.Location.Y is 480, btnCancel.Location.Y is 510, btnSave.Location.Y is 510
  </verify>
  <done>
Microphone ComboBox shows all active capture devices with full (non-truncated) names. System default device marked with "(System Default)" suffix. Selected device persists via AppSettings.MicrophoneDeviceNumber. Device list refreshes on each settings open. Invalid saved device falls back to "System Default" selection. TrayApplicationContext passes saved device number to every recording.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build**: `dotnet build Coxixo/Coxixo.csproj` succeeds with 0 errors, 0 warnings
2. **Model**: AppSettings.cs contains `int? MicrophoneDeviceNumber` with default null
3. **Service**: AudioCaptureService.StartCapture accepts `int? deviceNumber` parameter with fallback retry on BadDeviceId
4. **UI**: SettingsForm has microphone label and ComboBox between language dropdown and startup checkbox
5. **Enumeration**: EnumerateAudioDevices uses MMDeviceEnumerator for full names with WaveInEvent matching
6. **Default indicator**: System default device has "(System Default)" suffix in dropdown
7. **Validation**: ValidateDeviceNumber checks device index bounds and GetCapabilities before use
8. **Persistence**: BtnSave_Click saves MicrophoneDeviceNumber from ComboBox selection
9. **Wiring**: TrayApplicationContext.OnHotkeyPressed passes _settings.MicrophoneDeviceNumber to StartCapture
10. **Layout**: Form controls don't overlap, ClientSize accommodates all controls, consistent 55px spacing for microphone section
</verification>

<success_criteria>
- Microphone dropdown in settings lists all active capture devices with full names
- "System Default" is the first item in the dropdown (selected when MicrophoneDeviceNumber is null)
- Active system default device has "(System Default)" suffix on its display name
- Selected microphone device number saved to settings.json on Save button click
- App uses selected microphone device for recording via StartCapture(deviceNumber)
- Invalid/missing device gracefully falls back to system default (no crash)
- Build compiles with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-microphone-selection/08-01-SUMMARY.md`
</output>
