---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Coxixo.csproj
  - Coxixo/Program.cs
  - Coxixo/TrayApplicationContext.cs
  - Coxixo/Resources/icon-idle.ico
autonomous: true

must_haves:
  truths:
    - "App runs in system tray with icon visible"
    - "App remains running when idle (no window appears)"
    - "User can right-click tray icon to see context menu"
    - "User can exit app via tray menu"
    - "Tray icon disappears cleanly on exit (no ghost icons)"
  artifacts:
    - path: "Coxixo/Coxixo.csproj"
      provides: ".NET 8 WinForms project targeting Windows"
      contains: "net8.0-windows"
    - path: "Coxixo/Program.cs"
      provides: "Entry point with single-instance mutex and Application.Run"
      contains: "Application.Run"
    - path: "Coxixo/TrayApplicationContext.cs"
      provides: "ApplicationContext subclass owning NotifyIcon"
      contains: "class TrayApplicationContext : ApplicationContext"
    - path: "Coxixo/Resources/icon-idle.ico"
      provides: "System tray icon (16x16 minimum)"
      min_size: 1000
  key_links:
    - from: "Coxixo/Program.cs"
      to: "Coxixo/TrayApplicationContext.cs"
      via: "Application.Run(new TrayApplicationContext())"
      pattern: "Application\\.Run.*TrayApplicationContext"
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "NotifyIcon"
      via: "NotifyIcon instantiation with Visible=true"
      pattern: "NotifyIcon.*Visible\\s*=\\s*true"
---

<objective>
Create the .NET 8 WinForms project with system tray presence using ApplicationContext pattern.

Purpose: Establishes the application shell that all future phases build upon. The tray icon provides visual presence and the context menu provides user interaction point.

Output: A running Windows application that appears only in the system tray with a working context menu.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .NET 8 WinForms project with placeholder icon</name>
  <files>
    Coxixo/Coxixo.csproj
    Coxixo/Resources/icon-idle.ico
  </files>
  <action>
Create a new .NET 8 WinForms project:

```bash
dotnet new winforms -n Coxixo -f net8.0-windows
```

After project creation, modify Coxixo.csproj to:
- Set OutputType to WinExe
- Set ApplicationIcon to Resources\icon-idle.ico
- Add Resources folder with icon file as embedded resource

Create a placeholder 16x16 ICO file for the tray icon. Use any simple icon initially - this will be replaced with branded icon in Phase 4. A simple colored square is fine for now.

The csproj should include:
```xml
<PropertyGroup>
  <OutputType>WinExe</OutputType>
  <TargetFramework>net8.0-windows</TargetFramework>
  <UseWindowsForms>true</UseWindowsForms>
  <ApplicationIcon>Resources\icon-idle.ico</ApplicationIcon>
</PropertyGroup>

<ItemGroup>
  <EmbeddedResource Include="Resources\icon-idle.ico" />
</ItemGroup>
```
  </action>
  <verify>
Run `dotnet build Coxixo/Coxixo.csproj` - should succeed with no errors.
Verify icon file exists: `ls Coxixo/Resources/icon-idle.ico`
  </verify>
  <done>
Project compiles successfully. Icon file exists in Resources folder.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TrayApplicationContext with NotifyIcon</name>
  <files>
    Coxixo/Program.cs
    Coxixo/TrayApplicationContext.cs
  </files>
  <action>
Create TrayApplicationContext.cs following the ApplicationContext pattern from research:

```csharp
// TrayApplicationContext.cs
using System.Drawing;
using System.Reflection;
using System.Windows.Forms;

namespace Coxixo;

public class TrayApplicationContext : ApplicationContext
{
    private readonly NotifyIcon _trayIcon;

    public TrayApplicationContext()
    {
        // Load icon from embedded resource
        var icon = LoadEmbeddedIcon("Coxixo.Resources.icon-idle.ico");

        _trayIcon = new NotifyIcon
        {
            Icon = icon,
            Text = "Coxixo - Push to Talk",
            Visible = true,
            ContextMenuStrip = CreateContextMenu()
        };

        Application.ApplicationExit += OnApplicationExit;
    }

    private Icon LoadEmbeddedIcon(string resourceName)
    {
        var assembly = Assembly.GetExecutingAssembly();
        using var stream = assembly.GetManifestResourceStream(resourceName);
        if (stream == null)
        {
            // Fallback to application icon
            return Icon.ExtractAssociatedIcon(Application.ExecutablePath)
                   ?? SystemIcons.Application;
        }
        return new Icon(stream);
    }

    private ContextMenuStrip CreateContextMenu()
    {
        var menu = new ContextMenuStrip();
        menu.Items.Add("Settings...", null, OnSettingsClick);
        menu.Items.Add(new ToolStripSeparator());
        menu.Items.Add("Exit", null, OnExitClick);
        return menu;
    }

    private void OnSettingsClick(object? sender, EventArgs e)
    {
        // Placeholder - will show settings in Phase 4
        MessageBox.Show("Settings coming soon", "Coxixo",
            MessageBoxButtons.OK, MessageBoxIcon.Information);
    }

    private void OnExitClick(object? sender, EventArgs e)
    {
        Application.Exit();
    }

    private void OnApplicationExit(object? sender, EventArgs e)
    {
        CleanupTrayIcon();
    }

    private void CleanupTrayIcon()
    {
        _trayIcon.Visible = false;
        _trayIcon.Icon?.Dispose();
        _trayIcon.Dispose();
    }

    protected override void Dispose(bool disposing)
    {
        if (disposing)
        {
            CleanupTrayIcon();
        }
        base.Dispose(disposing);
    }
}
```

Modify Program.cs to use single-instance mutex and run TrayApplicationContext:

```csharp
// Program.cs
namespace Coxixo;

static class Program
{
    private static Mutex? _mutex;

    [STAThread]
    static void Main()
    {
        const string mutexName = "Global\\CoxixoSingleInstance";
        _mutex = new Mutex(true, mutexName, out bool createdNew);

        if (!createdNew)
        {
            MessageBox.Show("Coxixo is already running.", "Coxixo",
                MessageBoxButtons.OK, MessageBoxIcon.Information);
            return;
        }

        ApplicationConfiguration.Initialize();
        Application.Run(new TrayApplicationContext());
    }
}
```

IMPORTANT: Do NOT use `_trayIcon.Icon = null` before dispose - this can cause issues on some Windows versions. The pattern above (Visible=false, Icon.Dispose, then Dispose) is the correct cleanup sequence.
  </action>
  <verify>
Build and run the application:
```bash
dotnet run --project Coxixo/Coxixo.csproj
```
Verify:
1. Icon appears in system tray
2. Right-click shows context menu with "Settings..." and "Exit"
3. Clicking "Exit" closes the app
4. No duplicate icons remain after exit
5. Running a second instance shows "already running" message
  </verify>
  <done>
App runs in system tray with visible icon. Context menu works. Exit cleans up icon properly. Single-instance enforcement works.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build succeeds: `dotnet build Coxixo/Coxixo.csproj` exits with code 0
2. App runs from tray: `dotnet run --project Coxixo/Coxixo.csproj` shows tray icon
3. Single-instance: Running second instance shows dialog, doesn't create second icon
4. Clean exit: After "Exit" from menu, hover over where icon was - should not show tooltip
5. No ghost icons: Check system tray overflow area after multiple run/exit cycles
</verification>

<success_criteria>
- .NET 8 WinForms project exists at Coxixo/
- App runs without showing any window (formless)
- System tray icon is visible when app is running
- Right-click context menu has Settings and Exit options
- Exit properly disposes NotifyIcon (no ghost icons)
- Second instance is prevented via mutex
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
