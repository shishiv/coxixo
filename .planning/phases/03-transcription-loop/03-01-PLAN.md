---
phase: 03-transcription-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Coxixo/Coxixo.csproj
  - Coxixo/Services/TranscriptionService.cs
autonomous: true

must_haves:
  truths:
    - "TranscriptionService can send audio bytes to Azure Whisper and return text"
    - "Service handles transient errors with retry logic"
    - "Service is disposable and follows existing static service pattern"
  artifacts:
    - path: "Coxixo/Services/TranscriptionService.cs"
      provides: "Azure Whisper API client with retry"
      min_lines: 60
      exports: ["TranscriptionService", "TranscribeAsync"]
    - path: "Coxixo/Coxixo.csproj"
      provides: "Azure.AI.OpenAI package reference"
      contains: "Azure.AI.OpenAI"
  key_links:
    - from: "Coxixo/Services/TranscriptionService.cs"
      to: "Azure.AI.OpenAI SDK"
      via: "AzureOpenAIClient and AudioClient"
      pattern: "AudioClient.*TranscribeAudioAsync"
---

<objective>
Create the TranscriptionService that wraps Azure OpenAI Whisper API calls.

Purpose: Encapsulate all Azure API interaction in a single service, following the established service pattern. This service accepts audio bytes and returns transcribed text.

Output: Working TranscriptionService.cs with Azure.AI.OpenAI 2.1.0 integration and simple retry logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transcription-loop/03-RESEARCH.md

# Existing patterns to follow
@Coxixo/Services/CredentialService.cs
@Coxixo/Services/AudioCaptureService.cs
@Coxixo/Models/AppSettings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Azure.AI.OpenAI NuGet package</name>
  <files>Coxixo/Coxixo.csproj</files>
  <action>
Add Azure.AI.OpenAI version 2.1.0 package reference to the project file.

Run: `dotnet add Coxixo/Coxixo.csproj package Azure.AI.OpenAI --version 2.1.0`

This brings in the OpenAI SDK as a transitive dependency.
  </action>
  <verify>
Run `dotnet restore Coxixo/Coxixo.csproj` and confirm no errors.
Check Coxixo.csproj contains `<PackageReference Include="Azure.AI.OpenAI" Version="2.1.0" />`.
  </verify>
  <done>Azure.AI.OpenAI 2.1.0 package is added and restored successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create TranscriptionService</name>
  <files>Coxixo/Services/TranscriptionService.cs</files>
  <action>
Create `TranscriptionService.cs` in the Services folder with the following implementation:

**Class structure:**
- NOT a static class (unlike CredentialService/ConfigurationService) because it holds SDK client instances
- Implements IDisposable for proper cleanup
- Private fields: `_client` (AzureOpenAIClient), `_audioClient` (AudioClient)

**Constructor:**
- Parameters: `endpoint` (string), `apiKey` (string), `deployment` (string)
- Create `AzureOpenAIClient` with `new Uri(endpoint)` and `new AzureKeyCredential(apiKey)`
- Get `AudioClient` via `_client.GetAudioClient(deployment)`

**TranscribeAsync method:**
- Signature: `public async Task<string?> TranscribeAsync(byte[] audioData, CancellationToken ct = default)`
- Wrap audioData in MemoryStream (using statement)
- Create `AudioTranscriptionOptions` with:
  - `ResponseFormat = AudioTranscriptionFormat.Text`
  - `Language = "pt"` (Portuguese per PROJECT.md)
- Call `_audioClient.TranscribeAudioAsync(stream, "audio.wav", options, ct)`
- Return `result.Value.Text` (may be null/empty for silence)

**TranscribeWithRetryAsync method:**
- Signature: `public async Task<string?> TranscribeWithRetryAsync(byte[] audioData, int maxRetries = 2, CancellationToken ct = default)`
- Simple for-loop retry: attempt 0 to maxRetries
- Catch `RequestFailedException` where `IsTransient(ex)` returns true AND attempt < maxRetries
- Delay: `TimeSpan.FromSeconds(Math.Pow(2, attempt))` (1s, 2s exponential backoff)
- `IsTransient` helper: returns true for status >= 500 OR status == 408 OR status == 429

**Dispose:**
- Dispose `_client` (AzureOpenAIClient implements IDisposable)

**Using statements needed:**
- `using Azure;`
- `using Azure.AI.OpenAI;`
- `using OpenAI.Audio;`
- `using System.ClientModel;`
  </action>
  <verify>
Run `dotnet build Coxixo/Coxixo.csproj` - should compile without errors.
Check the file exists and contains TranscribeAsync and TranscribeWithRetryAsync methods.
  </verify>
  <done>
TranscriptionService.cs exists with:
- Constructor accepting endpoint, apiKey, deployment
- TranscribeAsync method using AudioClient.TranscribeAudioAsync
- TranscribeWithRetryAsync with exponential backoff for transient errors
- Proper IDisposable implementation
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` compiles without errors
2. TranscriptionService.cs exists in Coxixo/Services/
3. File contains: AzureOpenAIClient, AudioClient, TranscribeAsync, TranscribeWithRetryAsync
4. Azure.AI.OpenAI 2.1.0 is in csproj PackageReference
</verification>

<success_criteria>
- Azure.AI.OpenAI SDK installed and project builds
- TranscriptionService created following codebase patterns
- Retry logic implemented for transient failures (5xx, 429, 408)
- Service is ready to be wired into TrayApplicationContext (next plan)
</success_criteria>

<output>
After completion, create `.planning/phases/03-transcription-loop/03-01-SUMMARY.md`
</output>
