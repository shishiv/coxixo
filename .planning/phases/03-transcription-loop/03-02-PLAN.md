---
phase: 03-transcription-loop
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Coxixo/TrayApplicationContext.cs
autonomous: true

must_haves:
  truths:
    - "User releases hotkey and audio is sent to Azure OpenAI Whisper API"
    - "Transcription result is automatically copied to clipboard"
    - "User can paste transcribed text into any application"
    - "User receives notification if transcription fails"
    - "User is notified if API credentials are missing"
  artifacts:
    - path: "Coxixo/TrayApplicationContext.cs"
      provides: "Wired transcription flow with clipboard and error handling"
      contains: "TranscriptionService"
  key_links:
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "TranscriptionService"
      via: "field and TranscribeWithRetryAsync call"
      pattern: "_transcriptionService.*TranscribeWithRetryAsync"
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "Clipboard"
      via: "Clipboard.SetText in OnHotkeyReleased"
      pattern: "Clipboard\\.SetText"
    - from: "Coxixo/TrayApplicationContext.cs"
      to: "CredentialService"
      via: "LoadApiKey credential check"
      pattern: "CredentialService\\.LoadApiKey"
---

<objective>
Wire TranscriptionService into TrayApplicationContext to complete the core value loop.

Purpose: Connect the transcription service to the hotkey release flow, copy results to clipboard, and handle all error cases with user-friendly notifications.

Output: Complete "hold, speak, release, paste" workflow - the core value proposition of Coxixo.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transcription-loop/03-RESEARCH.md
@.planning/phases/03-transcription-loop/03-01-SUMMARY.md

# Files to modify
@Coxixo/TrayApplicationContext.cs
@Coxixo/Services/TranscriptionService.cs
@Coxixo/Services/CredentialService.cs
@Coxixo/Models/AppSettings.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire TranscriptionService into TrayApplicationContext</name>
  <files>Coxixo/TrayApplicationContext.cs</files>
  <action>
Modify TrayApplicationContext.cs to integrate TranscriptionService:

**Add field:**
- `private TranscriptionService? _transcriptionService;`
(Nullable because it's created lazily when credentials are valid)

**Modify constructor:**
After loading settings and before starting keyboard hook, attempt to initialize TranscriptionService:
- Call `TryInitializeTranscriptionService()` helper method (see below)

**Add TryInitializeTranscriptionService helper:**
```csharp
private bool TryInitializeTranscriptionService()
{
    var apiKey = CredentialService.LoadApiKey();
    if (string.IsNullOrEmpty(apiKey) || string.IsNullOrEmpty(_settings.AzureEndpoint))
    {
        _transcriptionService = null;
        return false;
    }

    _transcriptionService?.Dispose();
    _transcriptionService = new TranscriptionService(
        _settings.AzureEndpoint,
        apiKey,
        _settings.WhisperDeployment);
    return true;
}
```

**Modify OnHotkeyReleased to be async void:**
Replace the existing method with an async version that:

1. Stops capture and resets icon (existing code)
2. If audioData is null, return early (existing behavior)
3. Check if `_transcriptionService` is null:
   - Show balloon: "Configure API credentials in Settings"
   - Return early
4. Update tray text to "Coxixo - Transcribing..."
5. Try/catch block for transcription:
   - `var text = await _transcriptionService.TranscribeWithRetryAsync(audioData);`
   - If text is not null/whitespace: `Clipboard.SetText(text);`
   - Else: Show balloon "No speech detected" (Info icon)
6. Catch `RequestFailedException` - handle by status code:
   - 401: "Invalid API credentials. Check Settings."
   - 403: "Access denied. Check API permissions."
   - 404: "Whisper deployment not found. Check deployment name."
   - 429: "Rate limit exceeded. Try again later."
   - >= 500: "Azure service error. Try again."
   - Default: "API error: {message}"
7. Catch generic Exception: "Transcription failed: {message}"
8. Finally: Reset tray text to idle state

**Add ShowNotification helper** (if not already present):
```csharp
private void ShowNotification(string message, ToolTipIcon icon = ToolTipIcon.Warning)
{
    _trayIcon.BalloonTipTitle = "Coxixo";
    _trayIcon.BalloonTipText = message;
    _trayIcon.BalloonTipIcon = icon;
    _trayIcon.ShowBalloonTip(3000);
}
```

**Update Dispose:**
Add `_transcriptionService?.Dispose();` in the disposing block.

**Note on STA thread:** WinForms main thread is already STA (Program.cs has [STAThread]), so Clipboard.SetText can be called directly. The async continuation runs on the UI synchronization context.
  </action>
  <verify>
Run `dotnet build Coxixo/Coxixo.csproj` - should compile without errors.
Check that OnHotkeyReleased is now async and contains:
- TranscriptionService null check with notification
- Clipboard.SetText call
- RequestFailedException catch with status-specific messages
  </verify>
  <done>
TrayApplicationContext.cs modified with:
- TranscriptionService field and lazy initialization
- async OnHotkeyReleased with full transcription flow
- Clipboard.SetText for successful transcription
- Error handling with user-friendly balloon notifications
- Proper disposal of TranscriptionService
  </done>
</task>

<task type="auto">
  <name>Task 2: Manual integration test</name>
  <files></files>
  <action>
Build and run the application to verify the complete flow works:

1. Build: `dotnet build Coxixo/Coxixo.csproj`
2. Run: `dotnet run --project Coxixo/Coxixo.csproj`
3. App should start in system tray

**Test without credentials:**
- Press and release F8 (or configured hotkey)
- Should see balloon notification about configuring API credentials

**If user has configured credentials in %LOCALAPPDATA%\Coxixo\:**
- Hold F8, speak briefly, release
- Should hear start/stop beeps
- Tray should show "Transcribing..."
- Result should be copied to clipboard
- Can paste into Notepad to verify

Note: This is a smoke test. If credentials aren't configured, the "Configure API credentials" path is sufficient verification.
  </action>
  <verify>
Application builds and runs without crashing.
Without credentials: Shows "Configure API credentials" balloon on hotkey release.
With credentials: Transcription is attempted (may succeed or fail based on Azure config).
  </verify>
  <done>
Application runs and the transcription flow executes:
- Without credentials: User notified to configure
- With credentials: Audio sent to Azure, result to clipboard or error notification shown
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Coxixo/Coxixo.csproj` compiles without errors
2. TrayApplicationContext has:
   - `_transcriptionService` field
   - async `OnHotkeyReleased` method
   - `Clipboard.SetText(text)` call
   - `RequestFailedException` handling with status-specific messages
3. Application runs without crashing
4. Hotkey triggers transcription flow (with appropriate notifications)
</verification>

<success_criteria>
- Core value loop complete: hold key -> speak -> release -> paste
- Transcription result automatically copied to clipboard
- User receives clear notification on any error:
  - Missing credentials
  - Invalid credentials (401)
  - Rate limits (429)
  - Server errors (5xx)
- Application handles all error cases gracefully without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/03-transcription-loop/03-02-SUMMARY.md`
</output>
